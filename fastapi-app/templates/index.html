<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do List</title>
</head>
<body>
    <h1>To-Do List</h1>

    <form id="todo-form">
        <input type="text" id="title" placeholder="제목 (필수)" required>
        <input type="text" id="description" placeholder="설명 (선택)">
        <label for="group" style="margin-left:8px;">그룹:</label>
        <input type="number" id="group" min="1" max="9" step="1" value="1" style="width:3rem;">
        <button type="submit">Add To-Do</button>
    </form>

    <hr>
    <h3>필터 및 정렬</h3>
    <div>
        <label>상태:</label>
        <button type="button" class="filter-status" data-status="all">전체</button>
        <button type="button" class="filter-status" data-status="pending">미완료</button>
        <button type="button" class="filter-status" data-status="completed">완료</button>
        
        <label style="margin-left:16px;">그룹:</label>
        <button type="button" class="filter-group-btn" data-group="all">전체</button>
        <button type="button" class="filter-group-btn" data-group="1">1</button>
        <button type="button" class="filter-group-btn" data-group="2">2</button>
        <button type="button" class="filter-group-btn" data-group="3">3</button>
        <button type="button" class="filter-group-btn" data-group="4">4</button>
        <button type="button" class="filter-group-btn" data-group="5">5</button>
        <button type="button" class="filter-group-btn" data-group="6">6</button>
        <button type="button" class="filter-group-btn" data-group="7">7</button>
        <button type="button" class="filter-group-btn" data-group="8">8</button>
        <button type="button" class="filter-group-btn" data-group="9">9</button>
    </div>
    <div style="margin-top:8px;">
        <label>정렬:</label>
        <select id="sort-field">
            <option value="created_at">생성일</option>
            <option value="id">ID</option>
            <option value="title">제목</option>
            <option value="group">그룹</option>
            <option value="completed">완료상태</option>
            <option value="completed_at">완료일</option>
        </select>
        <select id="sort-order">
            <option value="desc">내림차순</option>
            <option value="asc">오름차순</option>
        </select>
    </div>
    <div style="margin-top:8px;">
        <span id="filter-display"></span>
    </div>
    <hr>

    <div id="groups"></div>
    <script>
        // 현재 필터 상태
        let currentFilters = {
            status: 'all',
            group: 'all',
            sortField: 'created_at',
            sortOrder: 'desc'
        };

        function fmt(dt) {
            if (!dt) return '';
            try {
                const d = new Date(dt);
                return d.toLocaleString();
            } catch { return dt; }
        }

        function el(tag, props = {}, ...children) {
            const e = document.createElement(tag);
            Object.entries(props).forEach(([k,v]) => {
                if (k === 'class') e.className = v; else if (k === 'onclick') e.onclick = v; else e.setAttribute(k, v);
            });
            children.flat().forEach(c => e.appendChild(typeof c === 'string' ? document.createTextNode(c) : c));
            return e;
        }

        function updateFilterDisplay() {
            const { status, group, sortField, sortOrder } = currentFilters;

            const statusText = status === 'all' ? '전체' : status === 'pending' ? '미완료' : '완료';
            const groupText = group === 'all' ? '전체' : group;
            const sortFieldText = {
                'created_at': '생성일',
                'id': 'ID',
                'title': '제목',
                'group': '그룹',
                'completed': '완료상태',
                'completed_at': '완료일'
            }[sortField] || sortField;
            const sortOrderText = sortOrder === 'asc' ? '오름차순' : '내림차순';

            document.getElementById('filter-display').textContent =
                `현재 필터: 상태=${statusText}, 그룹=${groupText}, 정렬=${sortFieldText}(${sortOrderText})`;
        }

        async function fetchTodos() {
            let url = '/todos';
            const { status, group, sortField, sortOrder } = currentFilters;

            updateFilterDisplay();

            // 상태 필터
            if (status !== 'all') {
                url = `/todos/status/${status}`;
            }
            // 그룹 필터
            else if (group !== 'all') {
                url = `/todos/group/${group}`;
            }

            // 정렬
            const sortUrl = `/todos/sorted?sort_by=${sortField}&order=${sortOrder}`;

            let todos;
            if (status === 'all' && group === 'all') {
                // 필터 없음 - 서버 정렬
                const response = await fetch(sortUrl);
                todos = await response.json();
            } else {
                // 필터 있음 - 클라이언트 정렬
                const response = await fetch(url);
                todos = await response.json();
                todos.sort((a, b) => {
                    let aVal = a[sortField];
                    let bVal = b[sortField];
                    if (aVal === null || aVal === undefined) return 1;
                    if (bVal === null || bVal === undefined) return -1;
                    if (aVal < bVal) return sortOrder === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            renderTodoList(todos);
        }

        function renderTodoList(todos) {
            const container = document.getElementById('groups');
            container.innerHTML = '';

            if (todos.length === 0) {
                container.innerHTML = '<p>할일이 없습니다.</p>';
                return;
            }

            // group by group number (1-9), only show those that exist
            const byGroup = new Map();
            todos.forEach(t => {
                const g = t.group ?? 1;
                if (!byGroup.has(g)) byGroup.set(g, []);
                byGroup.get(g).push(t);
            });

            const groups = Array.from(byGroup.keys()).sort((a,b) => a-b);
            groups.forEach((g, idx) => {
                if (idx > 0) container.appendChild(document.createElement('hr'));
                const section = el('div');
                section.appendChild(el('h2', {}, `Group ${g}`));

                const list = el('ul');
                byGroup.get(g).forEach(todo => {
                    const item = renderTodo(todo);
                    list.appendChild(item);
                });
                section.appendChild(list);
                container.appendChild(section);
            });
        }

        function renderTodo(todo) {
            const label = el('div', {},
                el('strong', {}, todo.title),
                ' ',
                todo.completed ? el('span', {}, '(완료)') : ''
            );
            const desc = todo.description ? el('div', {}, todo.description) : el('div');
            const meta = el('div', {},
                el('small', {}, `생성: ${fmt(todo.created_at)}`),
                todo.completed_at ? el('small', { style: 'margin-left:8px;' }, `완료: ${fmt(todo.completed_at)}`) : ''
            );

            const btns = el('div', { style: 'margin-top:4px;' });
            const editBtn = el('button', { type: 'button', onclick: () => editTodo(todo) }, '수정');
            const delBtn = el('button', { type: 'button', style: 'margin-left:4px;', onclick: () => deleteTodo(todo.id) }, '삭제');
            btns.appendChild(editBtn);
            btns.appendChild(delBtn);
            if (!todo.completed) {
                const doneBtn = el('button', { type: 'button', style: 'margin-left:4px;', onclick: () => completeTodo(todo.id) }, '완료');
                btns.appendChild(doneBtn);
            }

            const li = el('li');
            li.appendChild(label);
            li.appendChild(desc);
            li.appendChild(meta);
            li.appendChild(btns);
            return li;
        }

        document.getElementById('todo-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const group = Number(document.getElementById('group').value || '1');
            await fetch('/todos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ title, description: description || null, group })
            });
            (document.getElementById('title').value = '');
            (document.getElementById('description').value = '');
            (document.getElementById('group').value = '1');
            fetchTodos();
        });

        // 상태 필터 버튼
        document.querySelectorAll('.filter-status').forEach(btn => {
            btn.addEventListener('click', () => {
                currentFilters.status = btn.dataset.status;
                fetchTodos();
            });
        });

        // 그룹 필터 버튼
        document.querySelectorAll('.filter-group-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentFilters.group = btn.dataset.group;
                fetchTodos();
            });
        });

        // 정렬
        document.getElementById('sort-field').addEventListener('change', (e) => {
            currentFilters.sortField = e.target.value;
            fetchTodos();
        });

        document.getElementById('sort-order').addEventListener('change', (e) => {
            currentFilters.sortOrder = e.target.value;
            fetchTodos();
        });

        fetchTodos();

        async function completeTodo(id) {
            await fetch(`/todos/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ completed: true })
            });
            fetchTodos();
        }

        async function deleteTodo(id) {
            await fetch(`/todos/${id}`, { method: 'DELETE' });
            fetchTodos();
        }

        async function editTodo(todo) {
            const title = window.prompt('제목', todo.title);
            if (title === null || title.trim() === '') return; // cancel or empty
            const description = window.prompt('설명 (빈 값 허용)', todo.description || '') ?? '';
            const groupStr = window.prompt('그룹 (1-9)', String(todo.group ?? 1));
            let group = Number(groupStr);
            if (!Number.isFinite(group) || group < 1 || group > 9) group = todo.group ?? 1;
            await fetch(`/todos/${todo.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, description: description || null, group })
            });
            fetchTodos();
        }
    </script>
</body>
</html>
